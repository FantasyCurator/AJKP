<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AJKP "Form"</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-5">
  <h2 class="mb-4 text-center">AJKP Medical Card System</h2>

  <!-- Employee Info -->
  <div class="card mb-4">
    <div class="card-header">Employee Information</div>
    <div class="card-body">
      <form id="employeeForm">
        <div class="mb-3">
          <label class="form-label">Posting Place</label>
          <input type="text" class="form-control" id="postingPlace" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Full Name</label>
          <input type="text" class="form-control" id="fullName" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Designation</label>
          <input type="text" class="form-control" id="designation" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Employee CNIC (13 digits)</label>
          <input type="text" class="form-control" id="employeeCnic" maxlength="13" pattern="[0-9]{13}" required>
        </div>
      </form>
    </div>
  </div>

  <!-- Family Members -->
  <div class="card mb-4">
    <div class="card-header">Add Family Member</div>
    <div class="card-body">
      <form id="familyForm">
        <div class="mb-3">
          <label class="form-label">Relationship</label>
          <input type="text" class="form-control" id="relationship" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Full Name</label>
          <input type="text" class="form-control" id="familyName" required>
        </div>
        <div class="mb-3">
          <label class="form-label">CNIC (13 digits)</label>
          <input type="text" class="form-control" id="familyCnic" maxlength="13" pattern="[0-9]{13}" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Date of Birth</label>
          <input type="date" class="form-control" id="dob" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Marital Status</label>
          <select class="form-select" id="maritalstatus" required>
            <option value="">Select</option>
            <option value="Married">Married</option>
            <option value="Unmarried">Unmarried</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Job Status</label>
          <select class="form-select" id="jobstatus" required>
            <option value="">Select</option>
            <option value="Employed">Employed</option>
            <option value="Unemployed">Unemployed</option>
          </select>
        </div>
        <button type="button" id="addFamilyBtn" class="btn btn-secondary">Add Family Member</button>
      </form>
    </div>
  </div>

  <!-- Family List -->
  <div class="card mb-4">
    <div class="card-header">Family Members List</div>
    <div class="card-body">
      <table class="table table-bordered" id="familyTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Relationship</th>
            <th>Name</th>
            <th>CNIC</th>
            <th>DOB</th>
            <th>Marital</th>
            <th>Job</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="text-center">
    <button id="submitBtn" class="btn btn-primary btn-lg">Submit to Google Sheets</button>
    <p id="statusMsg" class="mt-3"></p>
  </div>
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbxFOm_XVgCPIj1XP4YHpoXUztFQbUaVIfI7oJYvEZ1MxK-Dt-7u3GyXFDibLdE8rTpAKg/exec"; // Replace with your Apps Script Web App URL
let familyMembers = [];

// Add family member to table
document.getElementById("addFamilyBtn").addEventListener("click", () => {
  const relationship = document.getElementById("relationship").value;
  const familyName = document.getElementById("familyName").value;
  const familyCnic = document.getElementById("familyCnic").value;
  const dob = document.getElementById("dob").value;
  const maritalstatus = document.getElementById("maritalstatus").value;
  const jobstatus = document.getElementById("jobstatus").value;

  if (!relationship || !familyName || !familyCnic || !dob || !maritalstatus || !jobstatus) {
    alert("Fill all family member fields.");
    return;
  }

  familyMembers.push({relationship, name: familyName, cnic: familyCnic, dob, maritalStatus: maritalstatus, jobStatus: jobstatus});
  renderTable();
  document.getElementById("familyForm").reset();
});

function renderTable() {
  const tbody = document.querySelector("#familyTable tbody");
  tbody.innerHTML = "";
  familyMembers.forEach((m, i) => {
    tbody.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${m.relationship}</td>
        <td>${m.name}</td>
        <td>${m.cnic}</td>
        <td>${m.dob}</td>
        <td>${m.maritalStatus}</td>
        <td>${m.jobStatus}</td>
      </tr>
    `;
  });
}

// Submit all data
document.getElementById("submitBtn").addEventListener("click", async () => {
  const postingPlace = document.getElementById("postingPlace").value;
  const fullName = document.getElementById("fullName").value;
  const designation = document.getElementById("designation").value;
  const employeeCnic = document.getElementById("employeeCnic").value;

  if (!postingPlace || !fullName || !designation || employeeCnic.length !== 13) {
    alert("Fill employee info correctly.");
    return;
  }
  if (familyMembers.length === 0) {
    alert("Add at least one family member.");
    return;
  }

  let formData = new FormData();
  formData.append("employee", JSON.stringify({postingPlace, fullName, designation, cnic: employeeCnic}));
  formData.append("familyMembers", JSON.stringify(familyMembers));

  document.getElementById("statusMsg").innerText = "Submitting...";

  try {
    let res = await fetch(scriptURL, {method: "POST", body: formData});
    let result = await res.json();
    if (result.result === "success") {
      document.getElementById("statusMsg").innerText = "✅ Data saved successfully!";
      document.getElementById("employeeForm").reset();
      familyMembers = [];
      renderTable();
    } else {
      document.getElementById("statusMsg").innerText = "❌ Error: " + result.error;
    }
  } catch (err) {
    document.getElementById("statusMsg").innerText = "❌ Request failed: " + err;
  }
});
</script>

</body>
</html>
